import{c as e,b as a,j as l,m as s,e as t,t as n,z as i,q as u,r,w as o,o as d,f as c,G as v,I as m,F as p,i as y,J as b,u as f,p as g,H as x,E as h}from"./vue-vendor-CVTqRqMI.js";import{_ as k,b as w}from"./index-ChpY04z8.js";import{p as A}from"./paymentsService-CP8J_m2z.js";import{t as _}from"./tenantsService-C1bOp5xB.js";import{u as M}from"./utilityDebtsService-Cmr5Tqws.js";import{j}from"./enums-CeMB0k1K.js";const B={class:"loading-content"},N={key:0,class:"loading-text"},I={key:1,class:"progress-container"},S={class:"progress-bar"},z={class:"progress-text"},F=k({__name:"LoadingSpinner",props:{loading:{type:Boolean,default:!1},text:{type:String,default:"Yükleniyor..."},fullscreen:{type:Boolean,default:!1},overlay:{type:Boolean,default:!0},showProgress:{type:Boolean,default:!1},progress:{type:Number,default:null},size:{type:String,default:"medium",validator:e=>["small","medium","large"].includes(e)}},setup(r){const o=r;return e(()=>{switch(o.size){case"small":return"w-8 h-8";case"large":return"w-16 h-16";default:return"w-12 h-12"}}),(e,o)=>r.loading?(s(),a("div",{key:0,class:u(["loading-overlay",{fullscreen:r.fullscreen,overlay:r.overlay}])},[t("div",B,[o[0]||(o[0]=t("div",{class:"spinner"},[t("div",{class:"spinner-ring"}),t("div",{class:"spinner-ring"}),t("div",{class:"spinner-ring"})],-1)),r.text?(s(),a("p",N,n(r.text),1)):l("",!0),r.showProgress&&null!==r.progress?(s(),a("div",I,[t("div",S,[t("div",{class:"progress-fill",style:i({width:`${r.progress}%`})},null,4)]),t("span",z,n(Math.round(r.progress))+"%",1)])):l("",!0)])],2)):l("",!0)}},[["__scopeId","data-v-83a88369"]]),L={key:0,class:"flex justify-center items-center py-12"},U={key:1,class:"advance-account-manager bg-base-100 p-6 rounded-lg shadow-lg"},Y={class:"form-control mb-6"},K=["value"],T={key:0,class:"mb-6"},V={class:"bg-base-200 p-4 rounded-lg"},C={class:"text-3xl font-bold text-primary"},D={class:"text-sm text-gray-600 mt-2"},E={key:1,class:"border-t pt-6"},$={class:"space-y-3 mb-4 max-h-80 overflow-auto pr-1"},P={class:"flex items-center justify-between gap-3"},H={class:"flex items-center gap-3 min-w-0"},R=["value","disabled"],q={class:"truncate"},G={class:"font-medium truncate"},J={class:"text-sm text-gray-600"},O={class:"ml-2"},Q={key:0,class:"w-36"},W=["onUpdate:modelValue","onInput","max"],X={key:0,class:"text-sm text-warning mt-2"},Z={key:0,class:"bg-base-200 p-4 rounded-lg mb-4"},ee={class:"flex justify-between mb-2"},ae={class:"font-semibold"},le={class:"flex justify-between mb-2"},se={class:"font-semibold"},te={class:"flex justify-between"},ne={key:0,class:"text-sm text-error mt-2"},ie=["disabled"],ue={key:0,class:"loading loading-spinner loading-sm"},re={key:2,class:"text-center py-8"},oe={key:3,class:"text-center py-8"},de={__name:"AdvanceAccountManager",props:{tenantId:{type:String,default:""}},emits:["success"],setup(i,{emit:k}){const{notifyError:B}=w(),N=i,I=k,S=r(!1),z=r([]),de=r(N.tenantId||""),ce=r(null),ve=r([]),me=r([]),pe=r({}),ye=e=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(Number(e||0)),be=e=>safeFormatDate(e,"dd MMM yyyy"),fe=e(()=>{var e;return Number((null==(e=null==ce?void 0:ce.value)?void 0:e.balance)||0)}),ge=e=>Number((null==e?void 0:e.remainingAmount)??(null==e?void 0:e.amount)??0),xe=e=>{const a=ve.value.find(a=>(a.id||a._id)===e);if(!a)return 0;const l=Number(pe.value[e]||0),s=_e(a);return!isFinite(l)||l<=0?0:Math.min(l,s)},he=e(()=>me.value.reduce((e,a)=>e+xe(a),0)),ke=e(()=>fe.value-he.value),we=e(()=>me.value.length>0&&he.value>0&&ke.value>=0),Ae=e=>fe.value>0&&ge(e)>0&&fe.value>=.01,_e=e=>{const a=ge(e),l=e.id||e._id,s=me.value.filter(e=>e!==l).reduce((e,a)=>{const l=Number(pe.value[a]||0),s=ve.value.find(e=>(e.id||e._id)===a),t=s?ge(s):1/0;return e+Math.min(l,t)},0),t=Math.max(0,fe.value-s);return Math.max(0,Math.min(a,t))},Me=async()=>{var e;if(me.value=[],pe.value={},ce.value=null,ve.value=[],de.value){S.value=!0;try{const a=await A.getAdvanceAccounts({tenantId:de.value,activeOnly:!0});ce.value=Array.isArray(a)?a[0]:(null==(e=null==a?void 0:a.items)?void 0:e[0])||null;const l=await M.getUtilityDebts({tenantId:de.value,status:"Unpaid"});ve.value=Array.isArray(l)?l:(null==l?void 0:l.items)||[]}catch(a){ce.value=null,ve.value=[]}finally{S.value=!1}}},je=async()=>{if(!S.value&&we.value){S.value=!0;try{const e=me.value.map(e=>({debtId:e,amount:xe(e)})).filter(e=>e.amount>0),a={tenantId:de.value,debtPayments:e,description:"Avans hesabından borç ödemesi"},l=await A.useAdvanceAccount(a);I("success",l),await Me()}catch(e){B("Avans kullanılamadı. Lütfen tekrar deneyin.")}finally{S.value=!1}}};return o(de,()=>{Me()}),o(me,(e,a)=>{e.filter(e=>!(null==a?void 0:a.includes(e))).forEach(e=>{const a=ve.value.find(a=>(a.id||a._id)===e);if(!a)return;const l=_e(a);pe.value[e]?pe.value[e]=Math.min(Number(pe.value[e]||0),l):pe.value[e]=l});(a||[]).filter(a=>!e.includes(a)).forEach(e=>{delete pe.value[e]})}),d(()=>{(async()=>{S.value=!0;try{const e=await _.getTenants();z.value=Array.isArray(e)?e:(null==e?void 0:e.items)||[]}catch(e){z.value=[]}finally{S.value=!1}})()}),(e,i)=>S.value?(s(),a("div",L,[c(F)])):(s(),a("div",U,[i[12]||(i[12]=t("h2",{class:"text-2xl font-bold mb-6 text-primary"},"Avans Hesabı Yönetimi",-1)),t("div",Y,[i[3]||(i[3]=t("label",{class:"label"},[t("span",{class:"label-text font-semibold"},"Kiracı Seçin")],-1)),v(t("select",{"onUpdate:modelValue":i[0]||(i[0]=e=>de.value=e),class:"select select-bordered",onChange:Me},[i[2]||(i[2]=t("option",{value:""},"Kiracı seçiniz",-1)),(s(!0),a(p,null,y(z.value,e=>(s(),a("option",{key:e.id||e._id,value:e.id||e._id},n((e=>(null==e?void 0:e.companyName)||(null==e?void 0:e.company)||[null==e?void 0:e.firstName,null==e?void 0:e.lastName].filter(Boolean).join(" ")||(null==e?void 0:e.fullName)||(null==e?void 0:e.email)||"Bilinmiyor")(e)),9,K))),128))],544),[[m,de.value]])]),ce.value?(s(),a("div",T,[t("div",V,[i[4]||(i[4]=t("h3",{class:"text-lg font-semibold mb-3"},"Mevcut Bakiye",-1)),t("div",C,n(ye(fe.value)),1),t("div",D," Son güncelleme: "+n(be(ce.value.updatedAt||ce.value.createdAt)),1)])])):l("",!0),ce.value&&ve.value.length>0?(s(),a("div",E,[i[9]||(i[9]=t("h3",{class:"text-lg font-semibold mb-4"},"Borç Öde",-1)),t("div",$,[(s(!0),a(p,null,y(ve.value,e=>(s(),a("div",{key:e.id||e._id,class:"border rounded-lg p-3"},[t("div",P,[t("div",H,[v(t("input",{"onUpdate:modelValue":i[1]||(i[1]=e=>me.value=e),value:e.id||e._id,type:"checkbox",class:"checkbox checkbox-sm checkbox-primary",disabled:!Ae(e)},null,8,R),[[b,me.value]]),t("div",q,[t("div",G,n(e.description||`${f(j)(e.type)} - ${e.periodYear}/${String(e.periodMonth).padStart(2,"0")}`),1),t("div",J,[g(" Kalan: "+n(ye(ge(e)))+" ",1),t("span",O,"| Vade: "+n(be(e.dueDate)),1)])])]),me.value.includes(e.id||e._id)?(s(),a("div",Q,[v(t("input",{"onUpdate:modelValue":a=>pe.value[e.id||e._id]=a,onInput:a=>(e=>{const a=e.id||e._id,l=Number(pe.value[a]||0);if(!isFinite(l)||l<=0)return void(pe.value[a]=0);const s=_e(e);pe.value[a]=Math.min(l,s)})(e),type:"number",step:"0.01",min:0,max:_e(e),class:"input input-sm input-bordered w-full",placeholder:"Tutar"},null,40,W),[[x,pe.value[e.id||e._id],void 0,{number:!0}]])])):l("",!0)]),Ae(e)?l("",!0):(s(),a("div",X," ⚠️ Yetersiz bakiye "))]))),128))]),me.value.length>0?(s(),a("div",Z,[i[8]||(i[8]=t("h4",{class:"font-semibold mb-2"},"Ödeme Özeti",-1)),t("div",ee,[i[5]||(i[5]=t("span",null,"Toplam Ödenecek:",-1)),t("span",ae,n(ye(he.value)),1)]),t("div",le,[i[6]||(i[6]=t("span",null,"Mevcut Bakiye:",-1)),t("span",se,n(ye(fe.value)),1)]),t("div",te,[i[7]||(i[7]=t("span",null,"Kalan Bakiye:",-1)),t("span",{class:u(["font-semibold",ke.value<0?"text-error":"text-success"])},n(ye(ke.value)),3)]),ke.value<0?(s(),a("div",ne," ⚠️ Yetersiz bakiye! Lütfen ödeme tutarlarını azaltın. ")):l("",!0)])):l("",!0),t("button",{onClick:je,class:"btn btn-primary",disabled:S.value||!we.value},[S.value?(s(),a("span",ue)):l("",!0),g(" "+n(S.value?"İşleniyor...":"Avans Kullan"),1)],8,ie)])):ce.value&&0===ve.value.length?(s(),a("div",re,i[10]||(i[10]=[h('<div class="text-gray-500"><svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p class="text-lg font-medium">Ödenecek borç bulunmuyor</p><p class="text-sm">Bu kiracının ödenmemiş borcu bulunmamaktadır.</p></div>',1)]))):de.value&&!ce.value?(s(),a("div",oe,i[11]||(i[11]=[h('<div class="text-gray-500"><svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg><p class="text-lg font-medium">Avans hesabı bulunamadı</p><p class="text-sm">Bu kiracının avans hesabı bulunmamaktadır.</p></div>',1)]))):l("",!0)]))}};export{F as L,de as _};
