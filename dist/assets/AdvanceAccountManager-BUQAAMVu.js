import{c as e,b as a,j as l,m as t,e as s,t as n,z as i,q as r,r as u,w as d,o,f as c,G as v,I as m,F as p,i as y,J as b,u as f,p as g,H as h,E as x}from"./vue-vendor-j_tVed2R.js";import{t as k,_ as w}from"./index-SuSpVQ5E.js";import{p as A}from"./paymentsService-Cx9lMbdY.js";import{t as _}from"./tenantsService-jvRYRtn0.js";import{u as M}from"./utilityDebtsService-CWShkKtZ.js";import{j}from"./enums-CeMB0k1K.js";import{p as B,i as z,e as N}from"./utils-vendor-Cy2sLATb.js";function I(e,a="dd.MM.yyyy"){if(!e)return"Tarih belirtilmedi";try{let l;if("string"==typeof e)l=B(e);else{if(!(e instanceof Date))return"Geçersiz tarih";l=e}return z(l)?l.getFullYear()<=1900?"Tarih belirtilmedi":N(l,a,{locale:k}):"Geçersiz tarih"}catch(l){return"Geçersiz tarih"}}const S={class:"loading-content"},T={key:0,class:"loading-text"},Y={key:1,class:"progress-container"},L={class:"progress-bar"},U={class:"progress-text"},F=w({__name:"LoadingSpinner",props:{loading:{type:Boolean,default:!1},text:{type:String,default:"Yükleniyor..."},fullscreen:{type:Boolean,default:!1},overlay:{type:Boolean,default:!0},showProgress:{type:Boolean,default:!1},progress:{type:Number,default:null},size:{type:String,default:"medium",validator:e=>["small","medium","large"].includes(e)}},setup(u){const d=u;return e(()=>{switch(d.size){case"small":return"w-8 h-8";case"large":return"w-16 h-16";default:return"w-12 h-12"}}),(e,d)=>u.loading?(t(),a("div",{key:0,class:r(["loading-overlay",{fullscreen:u.fullscreen,overlay:u.overlay}])},[s("div",S,[d[0]||(d[0]=s("div",{class:"spinner"},[s("div",{class:"spinner-ring"}),s("div",{class:"spinner-ring"}),s("div",{class:"spinner-ring"})],-1)),u.text?(t(),a("p",T,n(u.text),1)):l("",!0),u.showProgress&&null!==u.progress?(t(),a("div",Y,[s("div",L,[s("div",{class:"progress-fill",style:i({width:`${u.progress}%`})},null,4)]),s("span",U,n(Math.round(u.progress))+"%",1)])):l("",!0)])],2)):l("",!0)}},[["__scopeId","data-v-83a88369"]]),K={key:0,class:"flex justify-center items-center py-12"},V={key:1,class:"advance-account-manager bg-base-100 p-6 rounded-lg shadow-lg"},C={class:"form-control mb-6"},D=["value"],E={key:0,class:"mb-6"},G={class:"bg-base-200 p-4 rounded-lg"},$={class:"text-3xl font-bold text-primary"},P={class:"text-sm text-gray-600 mt-2"},H={key:1,class:"border-t pt-6"},R={class:"space-y-3 mb-4 max-h-80 overflow-auto pr-1"},q={class:"flex items-center justify-between gap-3"},J={class:"flex items-center gap-3 min-w-0"},O=["value","disabled"],Q={class:"truncate"},W={class:"font-medium truncate"},X={class:"text-sm text-gray-600"},Z={class:"ml-2"},ee={key:0,class:"w-36"},ae=["onUpdate:modelValue","onInput","max"],le={key:0,class:"text-sm text-warning mt-2"},te={key:0,class:"bg-base-200 p-4 rounded-lg mb-4"},se={class:"flex justify-between mb-2"},ne={class:"font-semibold"},ie={class:"flex justify-between mb-2"},re={class:"font-semibold"},ue={class:"flex justify-between"},de={key:0,class:"text-sm text-error mt-2"},oe=["disabled"],ce={key:0,class:"loading loading-spinner loading-sm"},ve={key:2,class:"text-center py-8"},me={key:3,class:"text-center py-8"},pe={__name:"AdvanceAccountManager",props:{tenantId:{type:String,default:""}},emits:["success"],setup(i,{emit:k}){const w=i,B=k,z=u(!1),N=u([]),S=u(w.tenantId||""),T=u(null),Y=u([]),L=u([]),U=u({}),pe=e=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(Number(e||0)),ye=e=>I(e,"dd MMM yyyy"),be=e(()=>{var e;return Number((null==(e=null==T?void 0:T.value)?void 0:e.balance)||0)}),fe=e=>Number((null==e?void 0:e.remainingAmount)??(null==e?void 0:e.amount)??0),ge=e=>{const a=Y.value.find(a=>(a.id||a._id)===e);if(!a)return 0;const l=Number(U.value[e]||0),t=Ae(a);return!isFinite(l)||l<=0?0:Math.min(l,t)},he=e(()=>L.value.reduce((e,a)=>e+ge(a),0)),xe=e(()=>be.value-he.value),ke=e(()=>L.value.length>0&&he.value>0&&xe.value>=0),we=e=>be.value>0&&fe(e)>0&&be.value>=.01,Ae=e=>{const a=fe(e),l=e.id||e._id,t=L.value.filter(e=>e!==l).reduce((e,a)=>{const l=Number(U.value[a]||0),t=Y.value.find(e=>(e.id||e._id)===a),s=t?fe(t):1/0;return e+Math.min(l,s)},0),s=Math.max(0,be.value-t);return Math.max(0,Math.min(a,s))},_e=async()=>{var e;if(L.value=[],U.value={},T.value=null,Y.value=[],S.value){z.value=!0;try{const a=await A.getAdvanceAccounts({tenantId:S.value,activeOnly:!0});T.value=Array.isArray(a)?a[0]:(null==(e=null==a?void 0:a.items)?void 0:e[0])||null;const l=await M.getUtilityDebts({tenantId:S.value,status:"Unpaid"});Y.value=Array.isArray(l)?l:(null==l?void 0:l.items)||[]}catch(a){T.value=null,Y.value=[]}finally{z.value=!1}}},Me=async()=>{if(!z.value&&ke.value){z.value=!0;try{const e=L.value.map(e=>({debtId:e,amount:ge(e)})).filter(e=>e.amount>0),a={tenantId:S.value,debtPayments:e,description:"Avans hesabından borç ödemesi"},l=await A.useAdvanceAccount(a);B("success",l),await _e()}catch(e){alert("Avans kullanılamadı. Lütfen tekrar deneyin.")}finally{z.value=!1}}};return d(S,()=>{_e()}),d(L,(e,a)=>{e.filter(e=>!(null==a?void 0:a.includes(e))).forEach(e=>{const a=Y.value.find(a=>(a.id||a._id)===e);if(!a)return;const l=Ae(a);U.value[e]?U.value[e]=Math.min(Number(U.value[e]||0),l):U.value[e]=l});(a||[]).filter(a=>!e.includes(a)).forEach(e=>{delete U.value[e]})}),o(()=>{(async()=>{z.value=!0;try{const e=await _.getTenants();N.value=Array.isArray(e)?e:(null==e?void 0:e.items)||[]}catch(e){N.value=[]}finally{z.value=!1}})()}),(e,i)=>z.value?(t(),a("div",K,[c(F)])):(t(),a("div",V,[i[12]||(i[12]=s("h2",{class:"text-2xl font-bold mb-6 text-primary"},"Avans Hesabı Yönetimi",-1)),s("div",C,[i[3]||(i[3]=s("label",{class:"label"},[s("span",{class:"label-text font-semibold"},"Kiracı Seçin")],-1)),v(s("select",{"onUpdate:modelValue":i[0]||(i[0]=e=>S.value=e),class:"select select-bordered",onChange:_e},[i[2]||(i[2]=s("option",{value:""},"Kiracı seçiniz",-1)),(t(!0),a(p,null,y(N.value,e=>(t(),a("option",{key:e.id||e._id,value:e.id||e._id},n((e=>(null==e?void 0:e.companyName)||(null==e?void 0:e.company)||[null==e?void 0:e.firstName,null==e?void 0:e.lastName].filter(Boolean).join(" ")||(null==e?void 0:e.fullName)||(null==e?void 0:e.email)||"Bilinmiyor")(e)),9,D))),128))],544),[[m,S.value]])]),T.value?(t(),a("div",E,[s("div",G,[i[4]||(i[4]=s("h3",{class:"text-lg font-semibold mb-3"},"Mevcut Bakiye",-1)),s("div",$,n(pe(be.value)),1),s("div",P," Son güncelleme: "+n(ye(T.value.updatedAt||T.value.createdAt)),1)])])):l("",!0),T.value&&Y.value.length>0?(t(),a("div",H,[i[9]||(i[9]=s("h3",{class:"text-lg font-semibold mb-4"},"Borç Öde",-1)),s("div",R,[(t(!0),a(p,null,y(Y.value,e=>(t(),a("div",{key:e.id||e._id,class:"border rounded-lg p-3"},[s("div",q,[s("div",J,[v(s("input",{"onUpdate:modelValue":i[1]||(i[1]=e=>L.value=e),value:e.id||e._id,type:"checkbox",class:"checkbox checkbox-sm checkbox-primary",disabled:!we(e)},null,8,O),[[b,L.value]]),s("div",Q,[s("div",W,n(e.description||`${f(j)(e.type)} - ${e.periodYear}/${String(e.periodMonth).padStart(2,"0")}`),1),s("div",X,[g(" Kalan: "+n(pe(fe(e)))+" ",1),s("span",Z,"| Vade: "+n(ye(e.dueDate)),1)])])]),L.value.includes(e.id||e._id)?(t(),a("div",ee,[v(s("input",{"onUpdate:modelValue":a=>U.value[e.id||e._id]=a,onInput:a=>(e=>{const a=e.id||e._id,l=Number(U.value[a]||0);if(!isFinite(l)||l<=0)return void(U.value[a]=0);const t=Ae(e);U.value[a]=Math.min(l,t)})(e),type:"number",step:"0.01",min:0,max:Ae(e),class:"input input-sm input-bordered w-full",placeholder:"Tutar"},null,40,ae),[[h,U.value[e.id||e._id],void 0,{number:!0}]])])):l("",!0)]),we(e)?l("",!0):(t(),a("div",le," ⚠️ Yetersiz bakiye "))]))),128))]),L.value.length>0?(t(),a("div",te,[i[8]||(i[8]=s("h4",{class:"font-semibold mb-2"},"Ödeme Özeti",-1)),s("div",se,[i[5]||(i[5]=s("span",null,"Toplam Ödenecek:",-1)),s("span",ne,n(pe(he.value)),1)]),s("div",ie,[i[6]||(i[6]=s("span",null,"Mevcut Bakiye:",-1)),s("span",re,n(pe(be.value)),1)]),s("div",ue,[i[7]||(i[7]=s("span",null,"Kalan Bakiye:",-1)),s("span",{class:r(["font-semibold",xe.value<0?"text-error":"text-success"])},n(pe(xe.value)),3)]),xe.value<0?(t(),a("div",de," ⚠️ Yetersiz bakiye! Lütfen ödeme tutarlarını azaltın. ")):l("",!0)])):l("",!0),s("button",{onClick:Me,class:"btn btn-primary",disabled:z.value||!ke.value},[z.value?(t(),a("span",ce)):l("",!0),g(" "+n(z.value?"İşleniyor...":"Avans Kullan"),1)],8,oe)])):T.value&&0===Y.value.length?(t(),a("div",ve,i[10]||(i[10]=[x('<div class="text-gray-500"><svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p class="text-lg font-medium">Ödenecek borç bulunmuyor</p><p class="text-sm">Bu kiracının ödenmemiş borcu bulunmamaktadır.</p></div>',1)]))):S.value&&!T.value?(t(),a("div",me,i[11]||(i[11]=[x('<div class="text-gray-500"><svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg><p class="text-lg font-medium">Avans hesabı bulunamadı</p><p class="text-sm">Bu kiracının avans hesabı bulunmamaktadır.</p></div>',1)]))):l("",!0)]))}};export{F as L,pe as _,I as s};
